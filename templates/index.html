<!DOCTYPE html>
<html lang="en">

<!-- Set the html metadata so that bootstrap, and plotly are installed aswell as link the css sheet. -->
  <head>
    <meta charset="UTF-8" />
    <title>Packet-Sleuth Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/static/images/Packet-Sleuth Logo.png">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <link rel="stylesheet" href="../static/css/main.css" />
  </head>

  <!-- Define the body of the page that contains 5 card divs, in a 3, 1, 1, arrangement aswell as a logo, title, and button. -->
  <body>
    <div class="container">
      <div id="top-bar" class="d-flex align-items-center mb-4">
        <img
          src="../static/images/Packet-Sleuth Logo.png"
          alt="Packet-Sleuth Logo"
          style="height: 115px; margin-right: 15px"
        />
        <h1 class="flex-grow-1 text-center mb-0">Packet-Sleuth Dashboard</h1>
        <button id="toggleScan" class="btn btn-primary">Start Scan</button>
      </div>
      <div class="d-flex mb-4">
        <div class="card small-card">
          <h5>Total Packets</h5>
          <p id="totalPackets">0</p>
        </div>
        <div class="card small-card">
          <h5>DDoS Probability</h5>
          <p id="ddosChance" style="font-weight: bold">0%</p>
        </div>
        <div class="card small-card">
          <h5>Top Protocol</h5>
          <p id="topProtocol">N/A</p>
        </div>
      </div>
      <div class="card">
        <h4 class="mb-3">Packets per Second</h4>
        <div id="packetChart"></div>
      </div>
      <div class="card" style="margin-top: 20px">
        <h4 class="mb-3">Packet Types</h4>
        <div id="packetChart2"></div>
      </div>
    </div>
    <div id="footer">&copy; 2025 Packet-Sleuth. All rights reserved.</div>
  </body>

  <script>
    // 1. Get Elements
    const toggleBtn = document.getElementById("toggleScan");
    let isRunning = false;

    // 2. Check status immediately on page load
    // This ensures the button state is correct if you refresh the page while sniffing
    fetch("/status_sniffer")
      .then((r) => r.json())
      .then((data) => {
        if (data.running) {
          isRunning = true;
          setButtonToStopMode();
        }
      })
      .catch((err) => console.log("Backend not reachable yet"));

    // 3. Button Click Logic
    toggleBtn.addEventListener("click", () => {
      if (!isRunning) {
        // --- SEND START COMMAND ---
        fetch("/start_sniffer", { method: "POST" })
          .then((r) => r.json())
          .then((data) => {
            if (data.running) {
              isRunning = true;
              setButtonToStopMode();
            }
          });
      } else {
        // --- SEND STOP COMMAND ---
        fetch("/stop_sniffer", { method: "POST" })
          .then((r) => r.json())
          .then((data) => {
            if (!data.running) {
              isRunning = false;
              setButtonToStartMode();
            }
          });
      }
    });

    // Helper functions to handle the visual CSS changes
    function setButtonToStopMode() {
      toggleBtn.textContent = "Stop Scan";
      toggleBtn.classList.remove("btn-primary");
      toggleBtn.classList.add("stop-mode");
    }

    function setButtonToStartMode() {
      toggleBtn.textContent = "Start Scan";
      toggleBtn.classList.remove("stop-mode");
      toggleBtn.classList.add("btn-primary");
    }

    // 4. Graph Update Loop (Polls Python every 0.5s)
    setInterval(async function () {
      if (!isRunning) return;

      try {
        const response = await fetch("/graph_data");
        const graphJSON = await response.json();

        // 1. Update Basic Stats
        document.getElementById("totalPackets").innerText =
          graphJSON.total_packets;
        document.getElementById("topProtocol").innerText =
          graphJSON.top_protocol;

        // 2. Update DDoS Probability with Color Coding
        const chanceElem = document.getElementById("ddosChance");
        const chanceVal = graphJSON.ddos_chance;

        chanceElem.innerText = chanceVal + "%";

        // Dynamic Text Color
        if (chanceVal > 80) {
          chanceElem.style.color = "#dc3545"; // Red
        } else if (chanceVal > 50) {
          chanceElem.style.color = "#ffc107"; // Yellow
        } else {
          chanceElem.style.color = "#eee"; // Blue (or White if you prefer)
        }

        // 3. Update Graphs
        Plotly.react(
          "packetChart",
          graphJSON.line_chart,
          graphJSON.line_layout
        );
        Plotly.react("packetChart2", graphJSON.pie_chart, graphJSON.pie_layout);
      } catch (error) {
        console.error("Error fetching graph data:", error);
      }
    }, 500);
  </script>
</html>
